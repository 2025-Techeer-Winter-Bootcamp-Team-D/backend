# Product Requirements Document (PRD)

## 주식 정보 분석 플랫폼

**버전**: 2.2
**작성일**: 2026-01-11
**최종 수정일**: 2026-01-11
**프로젝트**: 2025 Winter Bootcamp - Team D

---

## 1. 서비스 개요

### 1.1 개요 (Overview)

본 서비스는 **한국 주식 시장(KOSPI/KOSDAQ) 정보를 통합 제공하는 기업 분석 플랫폼**입니다. 사용자에게 기업별 상세 정보, 재무 지표, 주가 데이터, 뉴스, AI 기반 전망 분석 등을 제공하여 투자 의사결정을 지원합니다. **KIS(한국투자증권) API를 활용한 실시간 주가 스트리밍**을 통해 최신 시장 동향을 즉시 확인할 수 있습니다.

### 1.2 배경 및 목적 (Background & Purpose)

#### 배경
- 개인 투자자들이 기업 정보를 얻기 위해 여러 플랫폼을 오가야 하는 불편함 존재
- 전문적인 재무 데이터와 뉴스를 한 곳에서 확인할 수 있는 통합 플랫폼 필요
- AI 기술을 활용한 기업 전망 분석에 대한 수요 증가
- **실시간 주가 정보에 대한 접근성 향상 필요**

#### 목적
- **통합 정보 제공**: 기업 기본 정보, 재무 지표, 주가 차트, 관련 뉴스를 한 플랫폼에서 제공
- **실시간 데이터 제공**: KIS API 웹소켓을 통한 실시간 주가 스트리밍
- **기업 비교 기능**: 여러 기업을 비교 분석할 수 있는 기능 제공(사용자별로 저장 가능)
- **AI 전망 분석**: 기업 및 산업 전망을 AI 기반으로 분석하여 제공
- **개인화 서비스**: 즐겨찾기 기능을 통한 관심 기업 관리

### 1.3 타겟 사용자 (Target Users)

| 사용자 유형 | 설명 | 주요 니즈 |
|------------|------|----------|
| 개인 투자자 | 주식 투자에 관심 있는 일반인 | 쉽게 이해할 수 있는 기업 정보, 실시간 주가 차트 |
| 초보 투자자 | 주식 시장 입문자 | 직관적인 UI, 기업 비교 기능 |
| 정보 탐색자 | 기업/산업 동향 파악 목적 | 뉴스, AI 분석 리포트, 산업별 정보 |

---

## 2. 핵심 기능

### 2.1 필수 기능 (Must-Have Features)

#### 2.1.1 사용자 관리

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 회원가입 | 이메일, 사용자명, 비밀번호 기반 회원가입 | 상 |
| 로그인 | JWT 토큰 기반 인증 | 상 |
| 즐겨찾기 관리 | 관심 기업 추가/조회/삭제 | 상 |

#### 2.1.2 기업 정보

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 기업 검색 | 키워드 기반 기업 검색 | 상 |
| 기업 기본 정보 | 기업명, 종목코드, 산업분류, 설명 조회 | 상 |
| 기업 재무 지표 | 매출액, 영업이익, 매출 구성 등 시각화 | 상 |
| 주가 데이터 조회 | 1분/15분/1시간/일봉 OHLCV 차트 데이터 | 상 |
| 기업 뉴스 | 기업 관련 최신 뉴스 목록 | 상 |
| 기업 보고서 | 정기 보고서 목록 및 링크 제공 | 중 |

#### 2.1.3 실시간 주가 스트리밍 (신규 추가)

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 실시간 체결가 수신 | KIS WebSocket을 통한 실시간 거래가 수신 | 상 |
| 실시간 데이터 브로드캐스트 | Redis Pub/Sub을 통한 데이터 분배 | 상 |
| 클라이언트 스트리밍 | WebSocket/SSE를 통한 클라이언트 실시간 전달 | 상 |

**실시간 스트리밍 아키텍처**:
```
┌─────────────────┐
│   KIS API       │
│  (WebSocket)    │
└────────┬────────┘
         │ 실시간 체결가 수신
         ▼
┌─────────────────┐
│ KIS WebSocket   │
│ Client Container│
│ (Python Script) │
└────────┬────────┘
         │ Publish
         ▼
┌─────────────────┐
│  Redis Pub/Sub  │
│                 │
└────────┬────────┘
         │ Subscribe
         ▼
┌─────────────────┐
│  Django Server  │
│                 │
└────────┬────────┘
         │ WebSocket/SSE
         ▼
┌─────────────────┐
│ Frontend Client │
│                 │
└─────────────────┘
```

**기술 스택**:
- **데이터 소스**: KIS(한국투자증권) Open API - WebSocket
- **메시지 브로커**: Redis Pub/Sub
- **서버 → 클라이언트**: Django Channels (WebSocket) 또는 SSE (Server-Sent Events)

#### 2.1.4 기업 비교

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 비교 생성 | 여러 기업을 묶어 비교 매치업 생성 | 상 |
| 비교 목록 조회 | 저장된 비교 목록 조회 | 상 |
| 비교 상세 조회 | 선택한 비교의 결과 조회 | 상 |

#### 2.1.5 시장 지수

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| KOSPI 지수 조회 | 코스피 과거 데이터 및 차트 | 중 |
| KOSDAQ 지수 조회 | 코스닥 과거 데이터 및 차트 | 중 |

#### 2.1.6 순위 정보

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 기업 시총 순위 | 전체 기업 시가총액 순위 | 상 |
| 산업별 순위 | 산업별 기업 순위 | 중 |
| 산업 순위 | 산업 전체 순위 | 중 |

#### 2.1.7 뉴스 및 AI 전망 분석

| 기능 | 설명 | 우선순위 |
|-----|------|---------|
| 기업 전망 분석 | AI 기반 기업 전망 및 성장 점수 제공 | 중 |
| 산업 전망 분석 | AI 기반 산업별 전망 분석 | 중 |
| 기업 뉴스 조회 | 기업 관련 뉴스 조회 | 중 |
| 산업 뉴스 | 산업별 관련 뉴스 조회 | 중 |
| 뉴스 키워드 빈도 | 뉴스 키워드 빈도 순위 분석(WordCloud 시각화 목적) | 하 |

### 2.3 제외 기능 (Out of Scope)

| 기능 | 제외 사유 |
|-----|----------|
| 소셜 로그인 (OAuth) | 초기 버전에서는 이메일 기반 인증만 지원 |
| 모의 투자 기능 | 핵심 기능 완성 후 추후 버전에서 검토 |
| 알림/푸시 기능 | 인프라 복잡도 증가로 추후 검토 |
| 다국어 지원 | 한국어 우선 지원, 추후 확장 |

---

## 3. 기술 요구사항

### 3.1 시스템 아키텍처

#### 3.1.1 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              AWS Infrastructure                                                  │
│                                                                                                                  │
│  ┌──────────────────────────────────────────────────────┐    ┌──────────────────────────────────────────────┐   │
│  │              EC2-1: 애플리케이션 서버                   │    │            EC2-2: 데이터베이스 서버            │   │
│  │                                                       │    │                                              │   │
│  │  ┌─────────────────────────────────────────────────┐ │    │  ┌────────────────────────────────────────┐  │   │
│  │  │           Docker Container 1 (Main)              │ │    │  │          Docker Container              │  │   │
│  │  │                                                  │ │    │  │                                        │  │   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    │  │  ┌────────────────────────────────┐   │  │   │
│  │  │  │              Nginx                          │ │ │    │  │  │         PostgreSQL             │   │  │   │
│  │  │  │     (웹 서버 / 리버스 프록시 / SSL 종단)       │ │ │    │  │  │    (관계형 데이터 저장소)        │   │  │   │
│  │  │  └────────────────────────────────────────────┘ │ │    │  │  └────────────────────────────────┘   │  │   │
│  │  │                      │                          │ │    │  │                                        │  │   │
│  │  │                      ▼                          │ │    │  │  ┌────────────────────────────────┐   │  │   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    │  │  │         TimescaleDB            │   │  │   │
│  │  │  │        Django Server (DRF + Channels)       │ │ │    │  │  │     (시계열 데이터 저장소)       │   │  │   │
│  │  │  │            - REST API 제공                  │ │ │    │  │  │    - 주가 Tick 데이터 저장       │   │  │   │
│  │  │  │            - WebSocket 서버                 │ │ │    │  │  │    - OHLCV 집계 데이터          │   │  │   │
│  │  │  └────────────────────────────────────────────┘ │ │    │  │  └────────────────────────────────┘   │  │   │
│  │  │                      │                          │ │    │  │                                        │  │   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    │  │  ┌────────────────────────────────┐   │  │   │
│  │  │  │                  Redis                      │ │ │    │  │  │          OpenSearch            │   │  │   │
│  │  │  │    ┌─────────────────────────────────────┐ │ │ │    │  │  │       (검색 엔진 / 로그)         │   │  │   │
│  │  │  │    │ 1. Message Broker (Celery 작업 큐)   │ │ │ │    │  │  │    - 기업 검색 인덱스           │   │  │   │
│  │  │  │    │ 2. In-Memory Buffer (실시간 버퍼)    │ │ │ │    │  │  │    - 로그 분석                  │   │  │   │
│  │  │  │    │ 3. Pub/Sub (실시간 데이터 분배)      │ │ │ │    │  │  └────────────────────────────────┘   │  │   │
│  │  │  │    └─────────────────────────────────────┘ │ │ │    │  │                                        │  │   │
│  │  │  └────────────────────────────────────────────┘ │ │    │  └────────────────────────────────────────┘  │   │
│  │  │                      │                          │ │    │                                              │   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    └──────────────────────────────────────────────┘   │
│  │  │  │                 Celery                      │ │ │                         ▲                            │
│  │  │  │           (비동기 작업 처리)                 │ │ │                         │ DB 연결                     │
│  │  │  │    - 대용량 데이터 처리                     │ │ │                         │ (TCP/IP)                    │
│  │  │  │    - 주기적 작업 스케줄링                   │ │ │                         │                             │
│  │  │  └────────────────────────────────────────────┘ │ │    ┌──────────────────────┘                            │
│  │  │                                                  │ │    │                                                   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    │                                                   │
│  │  │  │               Monitoring                    │ │ │    │                                                   │
│  │  │  │           (모니터링 시스템)                  │ │ │    │                                                   │
│  │  │  │    - 서비스 상태 모니터링                    │ │ │    │                                                   │
│  │  │  │    - 메트릭 수집 및 알림                    │ │ │    │                                                   │
│  │  │  └────────────────────────────────────────────┘ │ │    │                                                   │
│  │  │                                                  │ │    │                                                   │
│  │  └─────────────────────────────────────────────────┘ │    │                                                   │
│  │                                                       │    │                                                   │
│  │  ┌─────────────────────────────────────────────────┐ │    │                                                   │
│  │  │        Docker Container 2 (KIS Client)          │ │    │                                                   │
│  │  │                                                  │ │    │                                                   │
│  │  │  ┌────────────────────────────────────────────┐ │ │    │                                                   │
│  │  │  │       Python Script (KIS WebSocket Client)  │◄┼─┼────┼── KIS Open API (한국투자증권)                     │
│  │  │  │           - KIS API WebSocket 연결          │ │ │    │   (wss://ops.koreainvestment.com)                 │
│  │  │  │           - 실시간 체결가 수신               │ │ │    │                                                   │
│  │  │  │           - Redis Pub/Sub Publish           │ │ │    │                                                   │
│  │  │  └────────────────────────────────────────────┘ │ │    │                                                   │
│  │  │                          │                       │ │    │                                                   │
│  │  └──────────────────────────┼───────────────────────┘ │    │                                                   │
│  │                             │ PUBLISH                  │    │                                                   │
│  │                             └──────────────────────────┼────┘                                                   │
│  │                                      Redis Pub/Sub     │                                                        │
│  └────────────────────────────────────────────────────────┘                                                        │
│                                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.1.2 아키텍처 다이어그램 - 데이터 흐름 중심

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        데이터 흐름 아키텍처                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│   ┌─────────────────┐                                                                               │
│   │  Frontend Client │◄────────────────── WebSocket/SSE ──────────────────┐                         │
│   │  (React + Vite)  │                                                    │                         │
│   └────────┬─────────┘                                                    │                         │
│            │ HTTP/REST                                                    │                         │
│            ▼                                                              │                         │
│   ┌─────────────────┐         ┌─────────────────┐         ┌──────────────┴──────────┐              │
│   │      Nginx       │────────►│  Django Server  │◄────────│      Redis Pub/Sub      │              │
│   │  (Reverse Proxy) │         │  (DRF+Channels) │         │   (실시간 데이터 구독)    │              │
│   └─────────────────┘         └────────┬────────┘         └──────────────┬──────────┘              │
│                                        │                                  │                         │
│                          ┌─────────────┼─────────────┐                   │ SUBSCRIBE               │
│                          │             │             │                   │                         │
│                          ▼             ▼             ▼                   │                         │
│              ┌───────────────┐ ┌─────────────┐ ┌─────────────┐          │                         │
│              │   PostgreSQL   │ │ TimescaleDB │ │  OpenSearch │◄─────────┼─────────────┐           │
│              │  (사용자/기업)  │ │ (시계열OHLCV)│ │(뉴스/검색)  │          │             │           │
│              └───────────────┘ └─────────────┘ └─────────────┘          │      Bulk Insert        │
│                          ▲             ▲                                 │             │           │
│                          │             │                                 │             │           │
│                          │      ┌──────┴────────┐                       │      ┌──────┴─────┐     │
│                          │      │    Celery      │───────────────────────┼─────►│Redis Buffer│     │
│                          │      │ (비동기 처리)   │   외부 API 데이터 수집   │      │(뉴스/크롤링)│     │
│                          │      │ - 데이터 집계   │   (Naver, Jina, DART)  │      └────────────┘     │
│                          │      │ - 배치 작업     │                       │                         │
│                          │      │ - 외부API 크롤링│                       │                         │
│                          │      └───────┬────────┘                       │                         │
│                          │              │                                │                         │
│                          │              │ Message Broker                 │                         │
│                          │              ▼                                │                         │
│                          │      ┌─────────────────┐                      │                         │
│                          │      │      Redis       │                      │                         │
│                          │      │  ┌───────────┐  │                      │                         │
│                          │      │  │ 작업 큐    │  │◄─────────────────────┘                         │
│                          │      │  │ (Broker)  │  │                                                │
│                          │      │  └───────────┘  │              ┌─────────────────┐               │
│                          │      │  ┌───────────┐  │◄──PUBLISH────│ KIS WebSocket   │               │
│                          │      │  │ Pub/Sub   │  │              │    Client       │               │
│                          │      │  │ (메시징)   │  │              │ (Python Script) │               │
│                          │      │  └───────────┘  │              └────────┬────────┘               │
│                          │      │  ┌───────────┐  │                       │                        │
│                          │      │  │ Buffer    │  │                       │ WebSocket              │
│                          │      │  │(캐시/버퍼) │  │                       │                        │
│                          │      │  └───────────┘  │                       ▼                        │
│                          │      └─────────────────┘              ┌─────────────────┐               │
│                          │                                       │  KIS Open API   │               │
│                          └───────────────────────────────────────│  (한국투자증권)  │               │
│                                    데이터 저장                    └─────────────────┘               │
│                                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                               External API 데이터 흐름 (뉴스/크롤링/재무)                          ││
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────┤│
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐               ││
│  │  │ Naver API  │  │  Jina.ai   │  │ DART API   │  │  yfinance  │  │  Gemini    │               ││
│  │  │  (뉴스)    │  │  (크롤링)   │  │  (재무)    │  │  (주가)    │  │   (AI)     │               ││
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘               ││
│  │        │               │               │               │               │                       ││
│  │        └───────────────┴───────────────┴───────────────┴───────────────┘                       ││
│  │                                        │                                                        ││
│  │                                        ▼                                                        ││
│  │                              ┌─────────────────┐                                                ││
│  │                              │  Celery Worker  │                                                ││
│  │                              │  (비동기 수집)   │                                                ││
│  │                              └────────┬────────┘                                                ││
│  │                                       │                                                         ││
│  │                   ┌───────────────────┼───────────────────┐                                    ││
│  │                   ▼                   ▼                   ▼                                    ││
│  │         ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                           ││
│  │         │  Redis Buffer   │ │   PostgreSQL    │ │   TimescaleDB   │                           ││
│  │         │ (뉴스/크롤링)    │ │   (재무 데이터)  │ │  (과거 주가)    │                           ││
│  │         └────────┬────────┘ └─────────────────┘ └─────────────────┘                           ││
│  │                  │ Batch Indexing (30초 주기)                                                  ││
│  │                  ▼                                                                             ││
│  │         ┌─────────────────┐                                                                    ││
│  │         │   OpenSearch    │                                                                    ││
│  │         │  (뉴스/문서 검색)│                                                                    ││
│  │         └─────────────────┘                                                                    ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.1.3 아키텍처 다이어그램 - 기술 스택 중심

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        기술 스택 아키텍처                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    Presentation Layer                                            ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  React 18 + Vite + Tailwind CSS + TradingView Lightweight Charts                          │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                               │                                                      │
│                                      HTTP/WebSocket/SSE                                             │
│                                               ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                     Gateway Layer                                                ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  Nginx (SSL Termination, Reverse Proxy, Load Balancing, Static Files)                     │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                               │                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                   Application Layer (EC2-1)                                      ││
│  │                                                                                                  ││
│  │  ┌─────────────────────────────────┐    ┌─────────────────────────────────┐                     ││
│  │  │      Django 6.0 + DRF           │    │         Celery Workers          │                     ││
│  │  │  ┌───────────────────────────┐  │    │  ┌───────────────────────────┐  │                     ││
│  │  │  │ REST API (drf-spectacular) │  │    │  │ 비동기 데이터 처리         │  │                     ││
│  │  │  │ Django Channels (WS/SSE)   │  │    │  │ 주기적 배치 작업          │  │                     ││
│  │  │  │ JWT Authentication         │  │    │  │ 데이터 집계               │  │                     ││
│  │  │  └───────────────────────────┘  │    │  └───────────────────────────┘  │                     ││
│  │  └─────────────────────────────────┘    └─────────────────────────────────┘                     ││
│  │                                                                                                  ││
│  │  ┌─────────────────────────────────┐    ┌─────────────────────────────────┐                     ││
│  │  │    KIS WebSocket Client         │    │          Monitoring             │                     ││
│  │  │  ┌───────────────────────────┐  │    │  ┌───────────────────────────┐  │                     ││
│  │  │  │ Python 3.12+ (asyncio)    │  │    │  │ 시스템 메트릭 수집         │  │                     ││
│  │  │  │ websockets, aiohttp       │  │    │  │ 서비스 헬스 체크          │  │                     ││
│  │  │  │ Redis Client              │  │    │  │ 알림                      │  │                     ││
│  │  │  └───────────────────────────┘  │    │  └───────────────────────────┘  │                     ││
│  │  └─────────────────────────────────┘    └─────────────────────────────────┘                     ││
│  │                                                                                                  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                               │                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    Caching & Messaging Layer                                     ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │                                      Redis 7                                               │  ││
│  │  │  ┌─────────────────┐  ┌─────────────────────┐  ┌───────────────────────────────────────┐  │  ││
│  │  │  │ Message Broker  │  │  In-Memory Buffer   │  │              Pub/Sub                   │  │  ││
│  │  │  │ (Celery 작업 큐) │  │ (세션/캐시/버퍼)     │  │    (실시간 주가 데이터 분배)            │  │  ││
│  │  │  └─────────────────┘  └─────────────────────┘  └───────────────────────────────────────┘  │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                               │                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                     Data Layer (EC2-2)                                           ││
│  │                                                                                                  ││
│  │  ┌────────────────────────────┐  ┌─────────────────────────┐  ┌────────────────────────────┐   ││
│  │  │       PostgreSQL           │  │      TimescaleDB        │  │        OpenSearch          │   ││
│  │  │  ┌──────────────────────┐  │  │  ┌─────────────────────┐│  │  ┌──────────────────────┐  │   ││
│  │  │  │ 사용자 데이터          │  │  │  │ Hypertable         ││  │  │ 기업 검색 인덱스      │  │   ││
│  │  │  │ 기업 메타데이터        │  │  │  │ (stock_ticks)      ││  │  │ 뉴스 인덱스          │  │   ││
│  │  │  │ 산업 정보             │  │  │  │ Continuous Aggs    ││  │  │ 로그 분석            │  │   ││
│  │  │  │ 즐겨찾기              │  │  │  │ (1m/15m/1h/1d)     ││  │  │                      │  │   ││
│  │  │  │ 비교 정보             │  │  │  │ 지수 데이터         ││  │  │                      │  │   ││
│  │  │  └──────────────────────┘  │  │  └─────────────────────┘│  │  └──────────────────────┘  │   ││
│  │  └────────────────────────────┘  └─────────────────────────┘  └────────────────────────────┘   ││
│  │                                                                                                  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    External Services                                             ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  KIS Open API (한국투자증권) - WebSocket (wss://ops.koreainvestment.com)                   │  ││
│  │  │  └─ 용도: 실시간 주가 스트리밍, 종목 체결가 수신                                             │  ││
│  │  │  └─ 연동: KIS WebSocket Client → Redis Pub/Sub → Django Channels                           │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  Gemini API (Google AI)                                                                    │  ││
│  │  │  └─ 용도: AI 기반 기업/산업 전망 분석, 재무제표 요약, 투자 인사이트 생성                       │  ││
│  │  │  └─ 연동: Django (companies/analysis, industries/analysis API)                              │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  Naver OpenAPI (네이버 뉴스 검색)                                                           │  ││
│  │  │  └─ 용도: 기업/산업 관련 뉴스 데이터 수집                                                    │  ││
│  │  │  └─ 연동: Celery Worker → Redis Buffer → OpenSearch 인덱싱                                  │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  Jina.ai (Reader API)                                                                      │  ││
│  │  │  └─ 용도: 웹 콘텐츠 크롤링 및 정보 추출 (뉴스 본문, 기업 정보 페이지 등)                       │  ││
│  │  │  └─ 연동: Celery Worker → Redis Buffer → OpenSearch 인덱싱                                  │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  DART OpenAPI (금융감독원 전자공시시스템)                                                    │  ││
│  │  │  └─ 용도: 기업 재무제표, 사업보고서, 공시 정보 수집                                          │  ││
│  │  │  └─ 연동: Celery Worker → PostgreSQL (재무 데이터 저장)                                     │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │  yfinance (Yahoo Finance 라이브러리)                                                        │  ││
│  │  │  └─ 용도: 과거 주가 데이터 백필, 보조 데이터 소스 (KIS API 장애 시 폴백)                      │  ││
│  │  │  └─ 연동: Celery Worker → TimescaleDB (OHLCV 데이터 저장)                                   │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                                  ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.1.4 Docker 컨테이너 구성

##### EC2-1: 애플리케이션 서버

**Docker Container 1 (Main)**

| 컨테이너 | 이미지 | 포트 | 역할 |
|---------|-------|-----|-----|
| **nginx** | nginx:latest | 80, 443 | 리버스 프록시, SSL 종단, 로드밸런싱, 정적 파일 서빙 |
| **app** | Django 6.0 (Custom) | 8000 | 메인 백엔드 API 서버, WebSocket/SSE 서버 (DRF + Channels) |
| **redis** | redis:7 | 6379 | Message Broker + In-Memory Buffer + Pub/Sub (3가지 역할) |
| **celery** | Python (Custom) | - | 비동기 작업 처리, 주기적 배치 작업, 데이터 집계 |
| **monitoring** | Custom | - | 서비스 상태 모니터링, 메트릭 수집, 알림 |

**Docker Container 2 (KIS Client)**

| 컨테이너 | 이미지 | 포트 | 역할 |
|---------|-------|-----|-----|
| **kis-ws-client** | Python 3.12 (Custom) | - | KIS API WebSocket 클라이언트, 실시간 체결가 수신, Redis Pub/Sub Publish |

##### EC2-2: 데이터베이스 서버

**Docker Container**

| 컨테이너 | 이미지 | 포트 | 역할 |
|---------|-------|-----|-----|
| **db** | timescale/timescaledb:latest-pg16 | 5432 | PostgreSQL + TimescaleDB (시계열 데이터) |
| **opensearch** | opensearch:latest | 9200, 9600 | 검색 엔진, 로그 분석, 기업 검색 인덱싱 |

#### 3.1.5 Redis의 3가지 역할

Redis는 단일 인스턴스에서 3가지 핵심 역할을 수행합니다.

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              Redis 7 (EC2-1)                               │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1. Message Broker (Celery 작업 큐)                 │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                      │   │
│  │  • Celery 비동기 작업 큐 관리                                         │   │
│  │  • 작업 상태 추적 (PENDING → STARTED → SUCCESS/FAILURE)              │   │
│  │  • 재시도 로직 및 실패 처리                                           │   │
│  │                                                                      │   │
│  │  사용 예시:                                                          │   │
│  │  - 대용량 데이터 처리 작업                                            │   │
│  │  - TimescaleDB 데이터 집계 작업                                      │   │
│  │  - 외부 API 호출 (뉴스 크롤링 등)                                     │   │
│  │                                                                      │   │
│  │  ┌─────────┐      ┌─────────┐      ┌─────────┐                      │   │
│  │  │ Django  │─────►│ Redis   │─────►│ Celery  │                      │   │
│  │  │ (작업등록)│      │ (큐저장) │      │ (처리)  │                      │   │
│  │  └─────────┘      └─────────┘      └─────────┘                      │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                 2. In-Memory Buffer (캐싱 및 데이터 버퍼링)            │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                      │   │
│  │  ■ 캐싱 용도                                                         │   │
│  │  • 세션 데이터 저장 (django.contrib.sessions.backends.cache)         │   │
│  │  • API 응답 캐싱 (자주 조회되는 기업 정보, 순위 등)                    │   │
│  │  • Rate Limiting 카운터                                              │   │
│  │                                                                      │   │
│  │  ■ OpenSearch 저장 전 버퍼링 (뉴스/크롤링 데이터)                      │   │
│  │  • 외부 API에서 수집한 뉴스/크롤링 데이터를 Redis List에 임시 저장     │   │
│  │  • Celery Beat이 주기적으로(30초) 버퍼 데이터를 OpenSearch에 Bulk Insert│   │
│  │  • OpenSearch의 near-realtime 특성을 고려한 쓰기 최적화               │   │
│  │  • 장애 시 데이터 유실 방지 (Redis에 버퍼링되어 복구 가능)             │   │
│  │                                                                      │   │
│  │  사용 예시:                                                          │   │
│  │  - 사용자 세션 정보 (JWT 토큰 블랙리스트 등)                          │   │
│  │  - 기업 기본 정보 캐싱 (TTL: 1시간)                                   │   │
│  │  - 시가총액 순위 캐싱 (TTL: 5분)                                      │   │
│  │  - 뉴스 데이터 버퍼 (Naver API → Redis List → OpenSearch)            │   │
│  │  - 크롤링 데이터 버퍼 (Jina.ai → Redis List → OpenSearch)            │   │
│  │                                                                      │   │
│  │  ┌─────────┐  GET/SET  ┌─────────┐  Bulk   ┌─────────────┐          │   │
│  │  │ Django  │◄─────────►│ Redis   │────────►│ OpenSearch  │          │   │
│  │  │ (API)   │           │(캐시/버퍼)│         │  (검색/로그) │          │   │
│  │  └─────────┘           └─────────┘         └─────────────┘          │   │
│  │                             ▲                                        │   │
│  │                   LPUSH     │                                        │   │
│  │                   ┌─────────┴─────────┐                              │   │
│  │                   │   Celery Worker   │                              │   │
│  │                   │ (외부 API 수집)    │                              │   │
│  │                   └───────────────────┘                              │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │             3. Data Messaging - Pub/Sub (실시간 주가 데이터 분배)      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                      │   │
│  │  • 실시간 주가 데이터 발행 (KIS Client → Redis)                       │   │
│  │  • 다중 구독자에게 동시 배포 (Redis → Django Channels)                │   │
│  │  • 느슨한 결합 구조 (Publisher/Subscriber 분리)                       │   │
│  │                                                                      │   │
│  │  채널 구조:                                                          │   │
│  │  - stock:realtime:{symbol} : 개별 종목 실시간 데이터                  │   │
│  │  - stock:realtime:*        : 전체 종목 와일드카드 구독                │   │
│  │                                                                      │   │
│  │  ┌───────────────┐  PUBLISH   ┌─────────┐  SUBSCRIBE  ┌───────────┐ │   │
│  │  │ KIS WebSocket │───────────►│  Redis  │◄────────────│  Django   │ │   │
│  │  │    Client     │            │ Pub/Sub │             │ Channels  │ │   │
│  │  └───────────────┘            └─────────┘             └─────┬─────┘ │   │
│  │                                                             │       │   │
│  │                                              WebSocket/SSE  │       │   │
│  │                                                             ▼       │   │
│  │                                                     ┌───────────┐   │   │
│  │                                                     │ Frontend  │   │   │
│  │                                                     │  Client   │   │   │
│  │                                                     └───────────┘   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

##### Redis 역할별 설정 예시

```python
# config/settings.py

# 1. Message Broker (Celery)
CELERY_BROKER_URL = 'redis://redis:6379/0'
CELERY_RESULT_BACKEND = 'redis://redis:6379/0'

# 2. In-Memory Buffer (캐시/세션)
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://redis:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
SESSION_CACHE_ALIAS = 'default'

# 3. Pub/Sub (Django Channels)
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            'hosts': [('redis', 6379)],
            'prefix': 'asgi:',
        },
    },
}
```

##### OpenSearch 버퍼링 구현 예시

```python
# apps/news/tasks.py
import redis
import json
from celery import shared_task
from opensearchpy import OpenSearch, helpers

redis_client = redis.Redis(host='redis', port=6379, db=2)

# Redis List 키 정의
BUFFER_KEY_NEWS = 'buffer:opensearch:news'
BUFFER_KEY_CRAWLED = 'buffer:opensearch:crawled'

@shared_task
def collect_news_from_naver(keyword: str):
    """Naver API에서 뉴스를 수집하여 Redis Buffer에 저장"""
    # Naver API 호출 로직
    news_items = fetch_from_naver_api(keyword)

    for item in news_items:
        # Redis List에 LPUSH (왼쪽에서 추가)
        redis_client.lpush(BUFFER_KEY_NEWS, json.dumps(item))

    # 버퍼 크기 제한 (최대 10,000개)
    redis_client.ltrim(BUFFER_KEY_NEWS, 0, 9999)

@shared_task
def flush_buffer_to_opensearch():
    """Redis Buffer의 데이터를 OpenSearch에 Bulk Insert (30초 주기)"""
    client = OpenSearch(hosts=[{'host': 'opensearch', 'port': 9200}])

    actions = []

    # Redis List에서 최대 500개씩 RPOP (오른쪽에서 제거)
    for _ in range(500):
        item = redis_client.rpop(BUFFER_KEY_NEWS)
        if item is None:
            break

        doc = json.loads(item)
        actions.append({
            '_index': 'news',
            '_source': doc
        })

    if actions:
        # OpenSearch Bulk Insert
        helpers.bulk(client, actions)

# Celery Beat 설정 (config/celery.py)
# CELERY_BEAT_SCHEDULE = {
#     'flush-buffer-every-30s': {
#         'task': 'apps.news.tasks.flush_buffer_to_opensearch',
#         'schedule': 30.0,  # 30초마다 실행
#     },
# }
```

#### 3.1.6 실시간 데이터 흐름 (Redis Pub/Sub)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                        실시간 주가 데이터 흐름                                │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. KIS API WebSocket 연결                                                  │
│  ┌─────────────────┐                                                        │
│  │ KIS WebSocket   │◄──── WebSocket 연결 (wss://ops.koreainvestment.com)   │
│  │ Client          │                                                        │
│  │ (Python)        │                                                        │
│  └────────┬────────┘                                                        │
│           │                                                                 │
│  2. 실시간 체결가 수신 및 Redis 발행                                           │
│           │                                                                 │
│           │  PUBLISH stock:realtime:{symbol}                               │
│           │  {                                                              │
│           │    "symbol": "005930",                                         │
│           │    "price": 75000,                                             │
│           │    "volume": 1234,                                             │
│           │    "timestamp": "2026-01-11T09:30:00.123Z"                     │
│           │  }                                                              │
│           ▼                                                                 │
│  ┌─────────────────┐                                                        │
│  │  Redis Pub/Sub  │                                                        │
│  │                 │                                                        │
│  └────────┬────────┘                                                        │
│           │                                                                 │
│  3. Django 서버 구독 및 클라이언트 전달                                        │
│           │  SUBSCRIBE stock:realtime:*                                    │
│           ▼                                                                 │
│  ┌─────────────────┐         WebSocket/SSE          ┌─────────────────┐    │
│  │ Django Channels │ ────────────────────────────► │ Frontend Client │    │
│  │ (WebSocket)     │                                │                 │    │
│  └─────────────────┘                                └─────────────────┘    │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 기술 스택

#### Backend
| 구분 | 기술 | 버전 | 용도 |
|-----|-----|-----|-----|
| 웹 프레임워크 | Django | 6.0 | 메인 백엔드 프레임워크 |
| API 프레임워크 | Django REST Framework | 최신 | REST API 구현 |
| WebSocket | Django Channels | 최신 | 실시간 양방향 통신 |
| API 문서화 | drf-spectacular | 최신 | OpenAPI/Swagger 문서 자동 생성 |
| KIS Client | Python (asyncio) | 3.12+ | KIS WebSocket 연결 및 데이터 수신 |
| 비동기 작업 | Celery | 최신 | 외부 API 데이터 수집, 배치 처리 |

#### External API Integration
| 서비스 | 용도 | 연동 앱/API |
|-------|------|------------|
| KIS Open API | 실시간 주가 스트리밍, 종목 체결가 수신 | KIS WebSocket Client → Redis Pub/Sub |
| Gemini API | AI 기반 기업/산업 전망 분석, 투자 인사이트 생성 | `companies/analysis`, `industries/analysis` API |
| Naver OpenAPI | 기업/산업 관련 뉴스 데이터 수집 | Celery Worker → Redis Buffer → OpenSearch |
| Jina.ai Reader | 웹 콘텐츠 크롤링 및 정보 추출 | Celery Worker → Redis Buffer → OpenSearch |
| DART OpenAPI | 기업 재무제표, 사업보고서, 공시 정보 수집 | Celery Worker → PostgreSQL |
| yfinance | 과거 주가 데이터 백필, KIS API 폴백 | Celery Worker → TimescaleDB |

#### Database
| 구분 | 기술 | 버전 | 용도 |
|-----|-----|-----|-----|
| 메인 DB | TimescaleDB | PostgreSQL 16 기반 | 시계열 데이터 저장 (주가, 지수) |
| 캐시/메시징 | Redis | 7 | 세션 관리, 캐싱, Pub/Sub |
| 검색 엔진 | OpenSearch | 최신 | 기업 검색, 로그 분석 |

#### Frontend
| 구분 | 기술 | 용도 |
|-----|-----|-----|
| 프레임워크 | React | UI 컴포넌트 |
| 빌드 도구 | Vite | 빠른 개발 서버 및 빌드 |
| 스타일링 | Tailwind CSS | 유틸리티 기반 CSS |
| 차트 라이브러리 | TradingView Lightweight Charts | 주가 차트 시각화 |
| 언어 | JavaScript | 클라이언트 로직 |

#### Infrastructure
| 구분 | 기술 | 용도 |
|-----|-----|-----|
| 클라우드 | AWS EC2 | 서버 호스팅 |
| 컨테이너화 | Docker | 개발/배포 환경 일관성 |
| 오케스트레이션 | Docker Compose | 로컬/프로덕션 환경 구성 |
| 웹 서버 | Nginx | 리버스 프록시, 로드 밸런싱 |

### 3.3 데이터베이스 설계

#### 3.3.1 주요 엔티티

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    Users     │     │  Industries  │     │  Companies   │
├──────────────┤     ├──────────────┤     ├──────────────┤
│ id (PK)      │     │ id (PK)      │     │ id (PK)      │
│ email        │     │ name         │     │ industry_id  │
│ username     │     │ description  │     │ name         │
│ password     │     │              │     │ symbol       │
│ created_at   │     │              │     │ description  │
└──────────────┘     └──────────────┘     │ logo         │
        │                   │             └──────────────┘
        │                   │                    │
        ▼                   ▼                    ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Favorites   │     │ IndustryNews │     │FinancialData │
├──────────────┤     ├──────────────┤     ├──────────────┤
│ id (PK)      │     │ id (PK)      │     │ id (PK)      │
│ user_id (FK) │     │ industry_id  │     │ company_id   │
│ company_id   │     │ title        │     │ year         │
│ created_at   │     │ url          │     │ revenue      │
└──────────────┘     │ summary      │     │ operating_   │
                     │ published_at │     │   profit     │
                     └──────────────┘     │ total_income │
                                          └──────────────┘
```

#### 3.3.2 시계열 데이터베이스 설계 (TimescaleDB)

##### 원본 Tick 데이터 (Hypertable)

```sql
-- 실시간 체결가 데이터 (원본 tick data)
CREATE TABLE stock_ticks (
    time        TIMESTAMPTZ NOT NULL,
    company_id  INTEGER NOT NULL,
    symbol      VARCHAR(10) NOT NULL,
    price       DECIMAL(12,2) NOT NULL,
    volume      BIGINT NOT NULL,
    trade_type  VARCHAR(1),  -- 'B': 매수, 'S': 매도
    CONSTRAINT stock_ticks_pkey PRIMARY KEY (time, company_id)
);

-- TimescaleDB Hypertable 생성 (시간 기준 자동 파티셔닝)
SELECT create_hypertable('stock_ticks', 'time',
    chunk_time_interval => INTERVAL '1 day'
);

-- 성능 최적화를 위한 인덱스
CREATE INDEX idx_stock_ticks_symbol_time ON stock_ticks (symbol, time DESC);
CREATE INDEX idx_stock_ticks_company_time ON stock_ticks (company_id, time DESC);
```

##### OHLCV 집계 테이블 (Continuous Aggregates)

```sql
-- 1분봉 OHLCV (Continuous Aggregate)
CREATE MATERIALIZED VIEW stock_prices_1m
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 minute', time) AS bucket,
    company_id,
    symbol,
    first(price, time) AS open,
    max(price) AS high,
    min(price) AS low,
    last(price, time) AS close,
    sum(volume) AS volume,
    sum(price * volume) AS amount,
    count(*) AS trade_count
FROM stock_ticks
GROUP BY bucket, company_id, symbol
WITH NO DATA;

-- 15분봉 OHLCV
CREATE MATERIALIZED VIEW stock_prices_15m
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('15 minutes', time) AS bucket,
    company_id,
    symbol,
    first(price, time) AS open,
    max(price) AS high,
    min(price) AS low,
    last(price, time) AS close,
    sum(volume) AS volume,
    sum(price * volume) AS amount,
    count(*) AS trade_count
FROM stock_ticks
GROUP BY bucket, company_id, symbol
WITH NO DATA;

-- 1시간봉 OHLCV
CREATE MATERIALIZED VIEW stock_prices_1h
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    company_id,
    symbol,
    first(price, time) AS open,
    max(price) AS high,
    min(price) AS low,
    last(price, time) AS close,
    sum(volume) AS volume,
    sum(price * volume) AS amount,
    count(*) AS trade_count
FROM stock_ticks
GROUP BY bucket, company_id, symbol
WITH NO DATA;

-- 1일봉 OHLCV
CREATE MATERIALIZED VIEW stock_prices_1d
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 day', time) AS bucket,
    company_id,
    symbol,
    first(price, time) AS open,
    max(price) AS high,
    min(price) AS low,
    last(price, time) AS close,
    sum(volume) AS volume,
    sum(price * volume) AS amount,
    count(*) AS trade_count
FROM stock_ticks
GROUP BY bucket, company_id, symbol
WITH NO DATA;
```

##### 자동 갱신 정책 (Refresh Policies)

```sql
-- 1분봉: 실시간에 가깝게 갱신 (30초마다)
SELECT add_continuous_aggregate_policy('stock_prices_1m',
    start_offset => INTERVAL '10 minutes',
    end_offset => INTERVAL '1 minute',
    schedule_interval => INTERVAL '30 seconds'
);

-- 15분봉: 5분마다 갱신
SELECT add_continuous_aggregate_policy('stock_prices_15m',
    start_offset => INTERVAL '1 hour',
    end_offset => INTERVAL '15 minutes',
    schedule_interval => INTERVAL '5 minutes'
);

-- 1시간봉: 15분마다 갱신
SELECT add_continuous_aggregate_policy('stock_prices_1h',
    start_offset => INTERVAL '4 hours',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '15 minutes'
);

-- 1일봉: 1시간마다 갱신
SELECT add_continuous_aggregate_policy('stock_prices_1d',
    start_offset => INTERVAL '3 days',
    end_offset => INTERVAL '1 day',
    schedule_interval => INTERVAL '1 hour'
);
```

##### 데이터 보관 정책 (Retention Policies)

```sql
-- 원본 tick 데이터: 7일 보관 후 자동 삭제
SELECT add_retention_policy('stock_ticks', INTERVAL '7 days');

-- 1분봉: 30일 보관
SELECT add_retention_policy('stock_prices_1m', INTERVAL '30 days');

-- 15분봉: 90일 보관
SELECT add_retention_policy('stock_prices_15m', INTERVAL '90 days');

-- 1시간봉: 1년 보관
SELECT add_retention_policy('stock_prices_1h', INTERVAL '1 year');

-- 1일봉: 무기한 보관 (별도 정책 없음)
```

##### 시계열 데이터 테이블 구조 요약

| 테이블/뷰 | 유형 | 시간 간격 | 갱신 주기 | 보관 기간 |
|----------|------|----------|----------|----------|
| `stock_ticks` | Hypertable (원본) | 실시간 tick | 즉시 | 7일 |
| `stock_prices_1m` | Continuous Aggregate | 1분 | 30초 | 30일 |
| `stock_prices_15m` | Continuous Aggregate | 15분 | 5분 | 90일 |
| `stock_prices_1h` | Continuous Aggregate | 1시간 | 15분 | 1년 |
| `stock_prices_1d` | Continuous Aggregate | 1일 | 1시간 | 무기한 |

##### 지수 데이터

```sql
-- 지수 데이터 (KOSPI, KOSDAQ)
CREATE TABLE index_data (
    time        TIMESTAMPTZ NOT NULL,
    index_type  VARCHAR(10) NOT NULL, -- 'KOSPI', 'KOSDAQ'
    close       DECIMAL(12,2),
    volume      BIGINT,
    amount      BIGINT
);

SELECT create_hypertable('index_data', 'time');
```

### 3.4 설계 원칙

- **물리적 FK 미설정**: 성능 최적화를 위해 논리적 관계만 유지
- **정규화 적용**: 데이터 중복 최소화를 위해 적극적 정규화
- **시계열 최적화**: TimescaleDB의 Hypertable 및 Continuous Aggregates 활용
- **자동 데이터 관리**: Retention Policy를 통한 오래된 데이터 자동 삭제
- **이벤트 기반 아키텍처**: Redis Pub/Sub을 활용한 느슨한 결합 구조

---

## 4. API 명세

### 4.1 사용자 API (`/users`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| POST | `/users/signup` | 회원가입 | X |
| POST | `/users/login` | 로그인 (JWT 발급) | X |
| POST | `/users/logout` | 로그아웃 | O |
| GET | `/users/favorites` | 즐겨찾기 목록 조회 | O |
| POST | `/users/favorites` | 즐겨찾기 추가 | O |
| DELETE | `/users/favorites/{favorite_id}` | 즐겨찾기 삭제 | O |

#### 4.1.1 회원가입
```http
POST /users/signup
Content-Type: application/json

{
  "email": "user@example.com",
  "username": "username",
  "password": "SecurePass123!"
}
```

**Response (201 Created)**
```json
{
  "status": 201,
  "message": "회원가입이 완료되었습니다.",
  "userId": 550
}
```

#### 4.1.2 로그인
```http
POST /users/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response (200 OK)**
```json
{
  "status": 200,
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "message": "로그인 성공"
}
```

### 4.2 기업 API (`/companies`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| GET | `/companies?keyword={value}` | 기업 검색 | X |
| GET | `/companies/{company_id}` | 기업 기본 정보 | X |
| GET | `/companies/{company_id}/financials` | 기업 재무 지표 | X |
| GET | `/companies/{company_id}/ohlcv?interval={value}` | 주가 데이터 조회 | X |
| GET | `/companies/{company_id}/news` | 기업 뉴스 조회 | X |
| GET | `/companies/{company_id}/reports` | 기업 보고서 조회 | X |
| GET | `/companies/{company_id}/analysis` | 기업 전망 분석 | X |

#### 4.2.1 기업 검색
```http
GET /companies?keyword=삼성
```

**Response (200 OK)**
```json
{
  "status": 200,
  "message": "기업 검색을 완료하였습니다.",
  "data": [
    {
      "companyId": 1,
      "name": "삼성전자",
      "logo": "https://..."
    }
  ]
}
```

#### 4.2.2 주가 데이터 조회
```http
GET /companies/1/ohlcv?interval=1d
```

**Query Parameters**:
- `interval`: `1m` (1분), `15m` (15분), `1h` (1시간), `1d` (1일)
- `start`: 시작 시간 (ISO 8601)
- `end`: 종료 시간 (ISO 8601)

**Response (200 OK)**
```json
{
  "status": 200,
  "message": "과거 주가 데이터 조회를 성공하였습니다.",
  "data": [
    {
      "time": 1704067200,
      "open": 75000.0,
      "high": 76500.0,
      "low": 74800.0,
      "close": 76000.0,
      "volume": 15234567,
      "amount": 1156789012345
    }
  ]
}
```

### 4.3 실시간 스트리밍 API (신규)

#### 4.3.1 WebSocket 연결
```
WebSocket: ws://api.example.com/ws/stocks/
```

**구독 메시지**:
```json
{
  "action": "subscribe",
  "symbols": ["005930", "000660", "035720"]
}
```

**수신 데이터**:
```json
{
  "type": "tick",
  "symbol": "005930",
  "price": 75000,
  "volume": 1234,
  "change": 500,
  "changePercent": 0.67,
  "timestamp": "2026-01-11T09:30:00.123Z"
}
```

#### 4.3.2 SSE 연결 (대안)
```http
GET /api/stream/stocks?symbols=005930,000660,035720
Accept: text/event-stream
```

**이벤트 스트림**:
```
event: tick
data: {"symbol":"005930","price":75000,"volume":1234,"timestamp":"2026-01-11T09:30:00.123Z"}

event: tick
data: {"symbol":"000660","price":180000,"volume":567,"timestamp":"2026-01-11T09:30:00.456Z"}
```

### 4.4 기업 비교 API (`/comparisons`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| GET | `/comparisons` | 비교 목록 조회 | O |
| POST | `/comparisons` | 비교 생성 | O |
| GET | `/comparisons/{comparison_id}` | 비교 상세 조회 | O |

#### 4.4.1 기업 비교 생성
```http
POST /comparisons
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "반도체 기업 비교",
  "companies": [1, 2, 3]
}
```

**Response (201 Created)**
```json
{
  "status": 201,
  "comparisonId": 1,
  "name": "반도체 기업 비교",
  "companies": [
    {"companyId": 1, "companyName": "삼성전자", "symbol": "005930"},
    {"companyId": 2, "companyName": "SK하이닉스", "symbol": "000660"},
    {"companyId": 3, "companyName": "DB하이텍", "symbol": "000990"}
  ],
  "createdAt": "2026-01-11"
}
```

### 4.5 산업 API (`/industries`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| GET | `/industries/{industry_id}/news` | 산업 뉴스 조회 | X |
| GET | `/industries/{industry_id}/analysis` | 산업 전망 분석 | X |

### 4.6 지수 API (`/indices`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| GET | `/indices/kospi` | KOSPI 지수 데이터 조회 | X |
| GET | `/indices/kosdaq` | KOSDAQ 지수 데이터 조회 | X |

### 4.7 순위 API (`/rankings`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|-----|
| GET | `/rankings/companies` | 기업 시총 순위 | X |
| GET | `/rankings/industries` | 산업 순위 | X |
| GET | `/rankings/industries/{industry_id}/companies` | 산업 내 기업 순위 | X |

---

## 5. 비기능적 요구사항

### 5.1 성능 (Performance)

| 지표 | 목표 | 측정 방법 |
|-----|-----|---------|
| API 응답 시간 | 평균 200ms 이하 | APM 모니터링 |
| 실시간 데이터 지연 | 500ms 이하 | 타임스탬프 비교 |
| 동시 접속자 | 1,000명 이상 | 부하 테스트 |
| WebSocket 연결 | 동시 500연결 | 부하 테스트 |
| 페이지 로드 | 3초 이내 | Lighthouse |
| 데이터베이스 쿼리 | 100ms 이하 | Query 로깅 |

#### 성능 최적화 전략
- **Redis 캐싱**: 자주 조회되는 데이터(기업 정보, 순위 등) 캐싱
- **Redis Pub/Sub**: 실시간 데이터 분배 최적화
- **TimescaleDB 최적화**: Continuous Aggregates를 통한 집계 쿼리 최적화
- **OpenSearch 인덱싱**: 기업 검색 성능 최적화
- **N+1 쿼리 방지**: Django ORM의 `select_related`, `prefetch_related` 활용
- **Connection Pooling**: 데이터베이스 및 Redis 연결 풀링

### 5.2 보안 (Security)

| 항목 | 구현 방안 |
|-----|----------|
| 인증 | JWT (JSON Web Token) 기반 인증 |
| 비밀번호 | 영문, 숫자, 특수문자 포함 8자 이상, bcrypt 해싱 |
| HTTPS | SSL/TLS 적용 (프로덕션) |
| API 보안 | Rate Limiting (429 Too Many Requests) |
| WebSocket 보안 | JWT 토큰 기반 연결 인증 |
| 데이터 보호 | 민감 정보 암호화 저장 |
| OpenSearch | 프로덕션 환경에서 보안 플러그인 활성화 필수 |
| KIS API 키 | 환경 변수로 관리, 코드에 노출 금지 |

### 5.3 확장성 (Scalability)

| 항목 | 전략 |
|-----|------|
| 수평 확장 | Docker 기반 컨테이너화로 손쉬운 스케일 아웃 |
| 데이터베이스 | TimescaleDB의 자동 파티셔닝으로 대용량 시계열 데이터 처리 |
| 캐시 레이어 | Redis 클러스터 구성 가능 |
| WebSocket | Django Channels + Redis 기반 분산 WebSocket |
| 메시지 브로커 | Redis Pub/Sub으로 다중 서버 간 메시지 동기화 |

### 5.4 가용성 (Availability)

| 항목 | 목표 |
|-----|------|
| 서비스 가용률 | 99% 이상 |
| 무중단 배포 | Nginx 로드밸런서를 통한 Blue-Green 배포 |
| 장애 복구 | 데이터베이스 백업 및 복구 절차 수립 |
| KIS 연결 복구 | WebSocket 자동 재연결 메커니즘 |

### 5.5 모니터링 및 로깅

| 항목 | 도구/방법 |
|-----|----------|
| 로그 수집 | OpenSearch를 통한 중앙 로그 관리 |
| API 모니터링 | Django 미들웨어 기반 요청/응답 로깅 |
| 실시간 모니터링 | Redis Pub/Sub 메시지 모니터링 |
| 에러 트래킹 | 구조화된 에러 응답 및 로깅 |

---

## 6. 우선순위 및 로드맵

### 6.1 개발 우선순위 매트릭스

```
                    높은 가치
                       │
    ┌──────────────────┼──────────────────┐
    │   Should Do      │    Must Do       │
    │   (중요/어려움)    │   (중요/쉬움)     │
    │                  │                  │
    │ - AI 전망 분석    │ - 회원가입/로그인  │
    │ - 산업 분석      │ - 기업 검색       │
    │                  │ - 기업 정보 조회   │
    │                  │ - 주가 차트       │
    │                  │ - 실시간 스트리밍  │
낮은 ├──────────────────┼──────────────────┤ 높은
노력 │   Nice to Have   │    Quick Wins    │ 노력
    │   (덜중요/어려움)  │   (덜중요/쉬움)   │
    │                  │                  │
    │ - 알림 기능      │ - 즐겨찾기        │
    │ - 모의 투자      │ - 기업 비교       │
    │                  │ - 순위 조회       │
    │                  │                  │
    └──────────────────┼──────────────────┘
                       │
                    낮은 가치
```

### 6.2 개발 로드맵 (2주)

#### Phase 1: MVP + 실시간 기반 (1주)
**목표**: 핵심 API 및 실시간 스트리밍 인프라 구축

| 일차 | Backend | Frontend |
|-----|---------|----------|
| 1-2일차 | - 프로젝트 구조 설정<br>- 사용자 인증 API (회원가입, 로그인, 로그아웃)<br>- TimescaleDB 스키마 설계 | - 프로젝트 설정 (Vite + React)<br>- 로그인/회원가입 페이지<br>- 기본 레이아웃 |
| 3-4일차 | - 기업 기본 정보 API<br>- 주가 데이터 API (OHLCV)<br>- KIS WebSocket Client 구현 | - 기업 상세 페이지<br>- 주가 차트 컴포넌트 (TradingView) |
| 5-6일차 | - Redis Pub/Sub 연동<br>- Django Channels WebSocket 설정<br>- 실시간 스트리밍 API | - 실시간 주가 표시<br>- WebSocket 연결 구현 |
| 7일차 | - 기업 검색 API<br>- 지수 데이터 API<br>- 통합 테스트 | - 검색 기능<br>- 메인 페이지 완성 |

#### Phase 2: 기능 확장 + 최적화 (1주)
**목표**: 부가 기능 완성 및 성능 최적화

| 일차 | Backend | Frontend |
|-----|---------|----------|
| 8-9일차 | - 즐겨찾기 API<br>- 기업 비교 API<br>- 기업 재무 지표 API | - 즐겨찾기 기능<br>- 기업 비교 페이지<br>- 재무 지표 시각화 |
| 10-11일차 | - 뉴스/보고서 API<br>- 순위 API<br>- Redis 캐싱 최적화 | - 뉴스 목록<br>- 순위 페이지<br>- 실시간 데이터 최적화 |
| 12-13일차 | - AI 전망 분석 API (기본)<br>- 성능 테스트<br>- 버그 수정 | - AI 분석 결과 표시<br>- UI/UX 개선<br>- 반응형 최적화 |
| 14일차 | - 최종 테스트<br>- 보안 점검<br>- 배포 준비 | - 최종 테스트<br>- 버그 수정<br>- 배포 |

### 6.3 마일스톤

| 마일스톤 | 일정 | 완료 조건 |
|---------|-----|----------|
| M1: 인프라 구축 | 2일차 | Docker Compose 환경 완성, KIS API 연동 테스트 |
| M2: 실시간 기반 완성 | 6일차 | Redis Pub/Sub + WebSocket 연동, 실시간 데이터 수신 확인 |
| M3: MVP 완성 | 7일차 | 핵심 API 및 페이지 완성, 기본 기능 테스트 통과 |
| M4: 기능 확장 | 11일차 | 즐겨찾기, 비교, 뉴스 기능 완성 |
| M5: 최종 릴리스 | 14일차 | 전체 기능 완성, 성능 테스트 통과, 배포 완료 |

---

## 7. 성공 지표 (Success Metrics)

### 7.1 기술적 지표

| 지표 | 목표 | 측정 방법 |
|-----|-----|---------|
| API 응답 시간 | P95 < 500ms | 로그 분석 |
| 실시간 데이터 지연 | < 500ms | 타임스탬프 비교 |
| WebSocket 안정성 | 재연결률 < 1% | 연결 로그 |
| 에러율 | < 1% | 에러 로깅 |
| 테스트 커버리지 | > 70% | pytest-cov |
| API 문서화율 | 100% | Swagger 자동 생성 |

### 7.2 프로젝트 지표

| 지표 | 목표 |
|-----|-----|
| 계획된 기능 완성도 | 100% Must-Have, 80% Should-Have |
| 코드 리뷰 완료율 | 100% |
| 문서화 완성도 | API 문서, README, 배포 가이드 완성 |

---

## 8. 위험 요소 및 완화 전략

### 8.1 기술적 위험

| 위험 요소 | 영향도 | 가능성 | 완화 전략 |
|----------|-------|-------|----------|
| KIS API 연결 불안정 | 상 | 중 | 자동 재연결 메커니즘, 로컬 버퍼링, 장애 알림 |
| TimescaleDB 학습 곡선 | 중 | 중 | 공식 문서 학습, 기본 PostgreSQL 쿼리 우선 사용 |
| WebSocket 확장성 | 중 | 중 | Redis 기반 채널 레이어, 연결 수 모니터링 |
| OpenSearch 설정 복잡도 | 중 | 중 | 개발 환경에서는 보안 비활성화, 프로덕션 전 별도 설정 |
| AI 분석 기능 구현 난이도 | 중 | 상 | 외부 API 활용 검토, 단순화된 버전 우선 구현 |

### 8.2 일정 위험

| 위험 요소 | 영향도 | 가능성 | 완화 전략 |
|----------|-------|-------|----------|
| 2주 일정 촉박 | 상 | 상 | Must-Have 집중, 병렬 개발, 일일 스탠드업 |
| 실시간 기능 복잡도 | 상 | 중 | 단계적 구현 (SSE 먼저, WebSocket 후순위) |
| 팀원 학습 시간 | 중 | 중 | 페어 프로그래밍, 지식 공유 세션 |
| 통합 이슈 | 중 | 중 | 조기 통합, 지속적 통합(CI) 적용 |

---

## 9. 팀 구성

| 역할 | 담당자 | 책임 |
|-----|-------|-----|
| Backend | 제승현 (리더), 강민서, 조장혁 | Django API 개발, 실시간 스트리밍, DB 설계, 서버 구축 |
| Frontend | 안근영, 차윤서 | React UI 개발, 차트 구현, WebSocket 연동, 사용자 경험 |

---

## 10. 참고 자료

- [KIS Developers - 한국투자증권 Open API](https://apiportal.koreainvestment.com/)
- [Microsoft REST API 설계 가이드](https://learn.microsoft.com/ko-kr/azure/architecture/best-practices/api-design)
- [Django REST Framework 문서](https://www.django-rest-framework.org/)
- [Django Channels 문서](https://channels.readthedocs.io/)
- [TimescaleDB 문서](https://docs.timescale.com/)
- [TimescaleDB Continuous Aggregates](https://docs.timescale.com/use-timescale/latest/continuous-aggregates/)
- [OpenSearch 문서](https://opensearch.org/docs/)
- [TradingView Lightweight Charts](https://tradingview.github.io/lightweight-charts/)
- [Redis Pub/Sub 문서](https://redis.io/docs/manual/pubsub/)

---

## 부록 A: 에러 코드 정의

| HTTP 상태 코드 | 코드 | 설명 |
|--------------|------|------|
| 400 | MISSING_FIELD | 필수 필드 누락 |
| 400 | INVALID_REQUEST | 잘못된 요청 형식 |
| 400 | INVALID_PASSWORD | 비밀번호 규칙 위반 |
| 401 | UNAUTHORIZED | 인증 필요 |
| 404 | NOT_FOUND | 리소스를 찾을 수 없음 |
| 409 | ALREADY_EXISTS | 이미 존재하는 리소스 |
| 429 | TOO_MANY_REQUESTS | 요청 한도 초과 |
| 503 | STREAM_UNAVAILABLE | 실시간 스트림 사용 불가 |

---

## 부록 B: KIS WebSocket Client 구현 가이드

### B.1 컨테이너 구조

```dockerfile
# kis-ws-client/Dockerfile
FROM python:3.12-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
CMD ["python", "main.py"]
```

### B.2 주요 의존성

```
# kis-ws-client/requirements.txt
websockets>=12.0
redis>=5.0
python-dotenv>=1.0
aiohttp>=3.9
```

### B.3 환경 변수

```bash
# KIS API 설정
KIS_APP_KEY=your_app_key
KIS_APP_SECRET=your_app_secret
KIS_ACCOUNT_NO=your_account_number

# Redis 설정
REDIS_HOST=redis
REDIS_PORT=6379

# 구독할 종목 리스트
SUBSCRIBE_SYMBOLS=005930,000660,035720
```

---

**문서 버전 이력**

| 버전 | 날짜 | 작성자 | 변경 내용 |
|-----|-----|-------|----------|
| 1.0 | 2026-01-10 | Claude (AI Assistant) | 초기 문서 작성 |
| 2.0 | 2026-01-11 | Claude (AI Assistant) | 실시간 스트리밍 기능 추가, 시스템 아키텍처 상세화, TimescaleDB 설계 상세화, 개발 기간 2주로 조정 |
| 2.1 | 2026-01-11 | Claude (AI Assistant) | 시스템 아키텍처 2개 EC2 구조로 업데이트, 데이터 흐름/기술 스택 다이어그램 추가, Redis 3가지 역할 상세 설명 추가, Docker 컨테이너 구성 EC2별 분리 |
| 2.2 | 2026-01-11 | Claude (AI Assistant) | External Services 확장 (Gemini, Naver OpenAPI, Jina.ai, DART OpenAPI, yfinance), Redis In-Memory Buffer의 OpenSearch 버퍼링 역할 추가, 데이터 흐름 다이어그램에 External API 흐름 추가, 기술 스택에 External API Integration 섹션 추가 |
